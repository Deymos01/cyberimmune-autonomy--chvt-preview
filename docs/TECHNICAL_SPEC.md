# Техническое задание

## 1. Цель проекта

Расширить существующую архитектуру автоматизированной навигационной системы (АНТС) путем внедрения двух новых компонентов:

- **Блок контроля доступа (Access Control Block)** – отвечает за проверку подлинности запросов, исходящих от отправителей заданий.
- **Менеджер ресурсов (Resource Manager)** – обеспечивает хранение и управление регулярными маршрутами, реализуя файловую систему маршрутов.

Новое решение должно гарантировать, что только уполномоченные отправители смогут активировать выполнение маршрутов, хранящихся в файловой системе, при этом в задание передаются лишь идентификаторы отправителя и маршрута.

## 2. Общие требования и структура системы

### 2.1. Структура передачи заданий (миссий)

**Новый формат задания:**  
Вместо передачи полного объекта маршрута миссия должна содержать только идентификатор отправителя (`sender_id`) и идентификатор маршрута (`route_id`).

**Пример:**

```json
{
    "sender_id": "sender_01",
    "route_id": "route_001"
}

## Цепочка обработки

1. Входящий запрос (миссия) поступает в **CommunicationGateway**.
2. Сначала осуществляется **проверка через блок контроля доступа**.
3. При положительном результате запрос передаётся в **Менеджер Ресурсов** для извлечения полного маршрута.
4. После получения полного маршрута данные комбинируются с информацией об отправителе и передаются в соответствующие очереди для дальнейшей обработки (например, в `ControlSystem` и `SafetyBlock`).

---

## 2.2. Взаимодействие компонентов

### Межпроцессный обмен сообщениями

- Для передачи событий внутри системы используются **очереди** (`Queue`), имена которых определены в конфигурационном файле  
  (например: `SERVOS_QUEUE_NAME`, `CONTROL_SYSTEM_QUEUE_NAME` и др.).

### Формат событий

События передаются в виде экземпляров класса `Event`, содержащих следующие поля:

- `source` – источник события  
- `destination` – целевая очередь получателя  
- `operation` – название операции (например, `"set_mission"`, `"set_speed"` и т.д.)  
- `parameters` – дополнительные параметры (в данном случае объект миссии или данные маршрута)

---

## 3. Блок контроля доступа (Access Control Block)

### 3.1. Функциональные требования

#### Приём запроса

Модуль должен принимать запросы, содержащие:

- `sender_id` – идентификатор отправителя
- `route_id` – идентификатор маршрута

#### Проверка прав доступа

Система должна содержать внутреннее хранилище или конфигурацию, в которой для каждого отправителя указаны разрешённые маршруты.

**Пример структуры данных:**

```python
allowed_mapping = {
    "sender_01": ["route_001", "route_005"],
    "sender_02": ["route_002", "route_003"],
    # ...
}

### Логика проверки

Метод `is_allowed(sender_id, route_id)` должен:

- Получать список разрешённых маршрутов для данного отправителя.
- Возвращать `True`, если `route_id` присутствует в списке.
- Возвращать `False`, если запрос не авторизован.

#### Логирование

При неудачной проверке система должна зафиксировать событие (логирование ошибки), указывая, что доступ для данного отправителя и маршрута запрещён.

---

## 3.2. Требования к реализации

- Модуль должен быть реализован в отдельном файле (например, `access_control.py`).
- Класс должен быть легко расширяемым (например, при изменении формата структуры данных, позволяющей хранить права доступа).
- В случае отсутствия данных о данном отправителе по умолчанию считается, что запрос отклоняется.

---

## 4. Менеджер ресурсов (Resource Manager)

### 4.1. Функциональные требования

#### Хранение маршрутов

Маршруты должны храниться:

- В виде отдельных файлов (например, `.json`).
- В демонстрационном варианте допустимо использование встроенного словаря.
- Для реального внедрения предпочтительно использовать файловую систему.

**Пример файла маршрута (JSON):**

```json
{
  "points": [
    {"lat": 55.7558, "lon": 37.6176},
    {"lat": 55.7522, "lon": 37.6156}
  ],
  "speed_limit": 60
}

### Получение маршрута

На основании входящего `route_id` модуль должен:

- Искать соответствующий файл или запись в хранилище.
- Извлекать данные.
- Возвращать их в виде объекта (например, словаря Python).

### Обработка ошибок

Если маршрут не найден, модуль должен:

- Сгенерировать исключение или уведомить вызывающий код об отсутствии данных.
- Записать информацию в лог об ошибке (например, `"Маршрут с id route_001 не найден"`).

---

## 4.2. Требования к реализации

- Модуль должен быть реализован в отдельном файле (например, `route_manager.py`).
- Путь к директории с маршрутами должен задаваться как параметр (например, `routes_dir`), что позволит при необходимости легко изменить источник данных.
- Реализация должна обеспечивать:
  - Корректное чтение данных с учетом кодировки.
  - Обработку ошибок ввода-вывода.

---

## 5. Изменение формата задания (миссии)

### 5.1. Функциональные требования

#### Формат входного запроса

Новая миссия должна содержать только два поля:

- `sender_id`
- `route_id`

#### Валидация запроса

На этапе формирования запроса необходимо предварительно проверить, что:

- Оба идентификатора переданы.
- Оба идентификатора не пустые.

#### Комбинирование данных

После успешной проверки доступа (см. раздел 3):

- Менеджер Ресурсов получает данные маршрута.
- Вся информация формируется в единый объект, который передаётся дальше в систему.

---

### 5.2. Требования к реализации

Изменить код в `CommunicationGateway` (или аналогичном модуле), чтобы он:

1. Извлекал `sender_id` и `route_id` из входящих параметров.
2. Вызывал блок контроля доступа для проверки прав.
3. При положительном результате вызывал Менеджер Ресурсов для загрузки маршрута.
4. Объединял данные для формирования окончательного объекта миссии.

**Формат конечного объекта миссии:**

```python
mission_data = {
    "sender_id": "sender_01",
    "route": { ... данные маршрута ... }
}

## 6. Интеграция нового функционала

### 6.1. Последовательность обработки запроса

#### Прием запроса

Запрос с идентификаторами `sender_id` и `route_id` поступает в компонент, отвечающий за получение миссии (например, через API или другой механизм).

#### Проверка доступа

- Идентификаторы передаются в блок контроля доступа.
- Если проверка возвращает `False`:
  - Запрос отклоняется.
  - Происходит логирование ошибки.
- Если проверка возвращает `True`, запрос передается на следующий этап.

#### Загрузка маршрута

- Менеджер ресурсов получает `route_id`.
- Если маршрут найден:
  - Извлекается и возвращается.
- Если маршрут не найден:
  - Генерируется уведомление об ошибке.
  - Запрос отклоняется.

#### Формирование и отправка миссии

- На основе данных проверки и маршрута формируется итоговый объект миссии.
- Объект передаётся в соответствующие очереди.
- Очереди назначения определяются конфигурацией:
  - `CONTROL_SYSTEM_QUEUE_NAME`
  - `SAFETY_BLOCK_QUEUE_NAME`
- Сообщения отправляются как экземпляры класса `Event`.

---

### 6.2. Техническое взаимодействие с другими компонентами

#### CommunicationGateway

- Необходимо модернизировать метод `_send_mission_to_consumers`, чтобы он выполнял следующие действия:
  - Извлечение идентификаторов.
  - Проверка доступа.
  - Загрузка маршрута.
  - Формирование и отправка объекта миссии.

#### ControlSystem и SafetyBlock

- Принимают событие с объектом миссии.
- Ожидаемые поля:
  - `route` — полный маршрут.
  - `sender_id` — идентификатор отправителя.
- Обработка выполняется стандартными алгоритмами.

---

## 7. Требования к тестированию

### 7.1. Юнит-тестирование

#### Модуль контроля доступа

- Проверка корректных и некорректных сочетаний `sender_id` и `route_id`.
- Проверка поведения при отсутствии данных об отправителе.

#### Менеджер ресурсов

- Тестирование поиска и чтения маршрутов из файловой системы.
- Сценарии с отсутствием файла маршрута или неверным форматом данных.

#### Изменённый CommunicationGateway

- End-to-end тест:
  - Прием миссии в новом формате.
  - Формирование корректного объекта миссии.
  - Отправка в очереди.
- Проверка логирования ошибок при некорректных запросах.

---

### 7.2. Интеграционное тестирование

- Проверка полной цепочки обработки запроса:
  1. Получение `sender_id` и `route_id`.
  2. Проверка доступа.
  3. Загрузка маршрута.
  4. Формирование и отправка объекта миссии в очереди.
- Моделирование отказов:
  - Отказ доступа.
  - Отсутствие маршрута.
- Убедиться, что система корректно обрабатывает исключительные ситуации.
